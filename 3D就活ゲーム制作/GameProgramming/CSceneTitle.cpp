#include "CSceneTitle.h"

#include "CRectangle.h"

#define WAITTIME_STARTLOAD 60 +60+30 //選択を決めてから次のシーンに移行するまでの時間
#define WAITTIME_NOWLOADING  110 //WAITTIME_STARTLOAD - 10 //「NOW LOADING」が表示されるまでの時間
#define WAITTIME_STARTFADEOUT  WAITTIME_STARTLOAD - 90 //WAITTIME_STARTLOAD - 10 //「NOW LOADING」が表示されるまでの時間

int CSceneTitle::mMode = 1; //コースやLap数の初期設定
int CSceneTitle::mDifficulty = 2; //敵AIの強さの初期設定　　1:EASY　2:NORMAL　3:HARD

//次のシーンの取得
CScene::EScene CSceneTitle::GetNextScene(){
	return mScene;
}


//初期化処理のオーバーライド
void CSceneTitle::Init() {
	//テクスチャファイルを読み込む
	//フォントの設定
	CText::mFont.Load("font\\font2nd.tga");
	CText::mFont.SetRowCol(8, 256 / 16);
	CText::mFont2.Load("font\\FontG.tga");
	CText::mFont2.SetRowCol(1, 4096 / 64);
	CText::mFont3.Load("font\\FontDIY.tga");//自作フォント
	CText::mFont3.SetRowCol(8, 176 / 11);
	//CText::mFont3.Load("FontDIYx5.tga");//自作フォント
	//CText::mFont3.SetRowCol(8, 880 / 55);//サイズ5倍(没)
	
	//シーンの設定
	mScene = ETITLE;

	mSelectScene_Level = 1;
	mPrevDifficulty = mDifficulty;
	mVariable1 = 0;
	mPrevVariable1 = mVariable1;
	mVariable2 = 0;
	mPrevVariable2 = mVariable2;
	mStart = false;
	mStartWaitTime = 0;
	SoundMoveCarsol.Load("SE\\Carsol2.wav");
	SoundDecide.Load("SE\\Decision_Small(SF).wav");
	SoundCancel.Load("SE\\Cancel2.wav");
}
//更新処理のオーバーライド
void CSceneTitle::Update() {
	//2D描画開始
	Start2D(0, 800, 0, 600);
	//R,G,B,α
	float c[] = { 1.0f, 1.0f, 1.0f, 1.0f };

	//文字列の描画
	CText::DrawString("3D-RACE", -278 + 400 + 68, 430, 36, 36);
	c[0] = c[1] = c[2] = 0.0f;
	glColor4fv(c);
	CText::DrawString("Demo Ver0.0", -278 + 400 + 68 + 131, 345 + 32, 8, 8, 3);
	c[0] = c[1] = c[2] = 1.0f;
	glColor4fv(c);
	CText::DrawString("Push Enter Key", 200, 177, 16, 16);
	//
	if (mSelectScene_Level == 1){
		CText::DrawString("[", 66 + mVariable2 * 250, 284 + mVariable1 * 50, 20, 30, 2);
		CText::DrawString("]", 262 + mVariable2 * 250, 284 + mVariable1 * 50, 20, 30, 2);
	}
	if (mSelectScene_Level == 2 && mStart == false){
		if (mDifficulty == 1){
			CText::DrawString("[", 190, 102, 16, 24, 2);
			CText::DrawString("]", 278, 102, 16, 24, 2);
		}
		if (mDifficulty == 2){
			CText::DrawString("[", 338, 102, 16, 24, 2);
			CText::DrawString("]", 474, 102, 16, 24, 2);
		}
		if (mDifficulty == 3){
			CText::DrawString("[", 534, 102, 16, 24, 2);
			CText::DrawString("]", 622, 102, 16, 24, 2);
		}
	}

	//ここより前は選択時に点滅しない
	if (mStartWaitTime > 20 || mStart == false){
		c[0] = c[1] = c[2] = 1.0f;
	}
	else if (mStartWaitTime % 8 < 4){
		c[0] = c[1] = c[2] = 0.5f;
	}
	glColor4fv(c);
	//ここから先は選択時に点滅させることが可能

	////モード選択と難易度選択でカーソルの基点も違う
	//if (mSelectScene_Level == 1){
	//	//CText::DrawString("O", 170 + mVariable2 * 250, 300 + mVariable1 * 50, 10, 10);
	//}
	////else if (mSelectScene_Level == 2){
	////	//if (mDifficulty == 1){
	////	//	//CText::DrawString("O", 175, 100, 10, 10);
	////	//	CText::DrawString("[", 190, 102, 16, 24, 2);
	////	//	CText::DrawString("]", 278, 102, 16, 24, 2);
	////	//}
	////	//if (mDifficulty == 2){
	////	//	//CText::DrawString("O", 323, 100, 10, 10);
	////	//	CText::DrawString("[", 338, 102, 16, 24, 2);
	////	//	CText::DrawString("]", 474, 102, 16, 24, 2);
	////	//}
	////	//if (mDifficulty == 3){
	////	//	//CText::DrawString("O", 519, 100, 10, 10);
	////	//	CText::DrawString("[", 534, 102, 16, 24, 2);
	////	//	CText::DrawString("]", 622, 102, 16, 24, 2);
	////	//}
	////	//CText::DrawString("O", -80 + mDifficulty * 250, 100, 10, 10);
	////}


	/*難易度選択(敵AIの強さ)*/
	if (mDifficulty == 1 && mSelectScene_Level == 2){//難易度:EASY
		c[0] = c[1] = c[2] = 1.0f; c[3] = 1.0f;
	}
	else{
		c[0] = c[1] = c[2] = 0.5f; c[3] = 1.0f;
	}
	//選択時に点滅する
	if (mStart && mDifficulty == 1){
		if (mStartWaitTime > 20){
			c[0] = c[1] = c[2] = 1.0f;
		}
		else if (mStartWaitTime % 8 < 4){
			c[0] = c[1] = c[2] = 0.5f;
		}
	}
	glColor4fv(c);
	CText::DrawString("EASY", 200, 100, 12, 12);

	if (mDifficulty == 2 && mSelectScene_Level == 2){//難易度:NORMAL
		c[0] = c[1] = c[2] = 1.0f; c[3] = 1.0f;
	}
	else{
		c[0] = c[1] = c[2] = 0.5f; c[3] = 1.0f;
	}
	//選択時に点滅する
	if (mStart && mDifficulty == 2){
		if (mStartWaitTime > 20){
			c[0] = c[1] = c[2] = 1.0f;
		}
		else if (mStartWaitTime % 8 < 4){
			c[0] = c[1] = c[2] = 0.5f;
		}
	}
	glColor4fv(c);
	CText::DrawString("NORMAL", 347, 100, 12, 12);

	if (mDifficulty == 3 && mSelectScene_Level == 2){//難易度:HARD
		c[0] = c[1] = c[2] = 1.0f; c[3] = 1.0f;
	}
	else{
		c[0] = c[1] = c[2] = 0.5f; c[3] = 1.0f;
	}
	//選択時に点滅する
	if (mStart && mDifficulty == 3){
		if (mStartWaitTime > 20){
			c[0] = c[1] = c[2] = 1.0f;
		}
		else if (mStartWaitTime % 8 < 4){
			c[0] = c[1] = c[2] = 0.5f;
		}
	}
	glColor4fv(c);
	CText::DrawString("HARD", 543, 100, 12, 12);

	/*モード選択(ステージ選択)の項目*/
	if (mVariable1 == 0 && mVariable2 == 0){
		c[0] = c[1] = c[2] = 1.0f; c[3] = 1.0f;
	}
	else{
		c[0] = c[1] = c[2] = 0.5f; c[3] = 1.0f;
	}
	//選択時に点滅する
	if (mStart && mVariable1 == 0 && mVariable2 == 0){
		if (mStartWaitTime > 20){
			c[0] = c[1] = c[2] = 1.0f;
		}
		else if (mStartWaitTime % 8 < 4){
			c[0] = c[1] = c[2] = 0.5f;
		}
	}
	glColor4fv(c);
	CText::DrawString("COURCE-1", 80, 280, 12, 14);

	if (mVariable1 == 0 && mVariable2 == 1){
		c[0] = c[1] = c[2] = 1.0f; c[3] = 1.0f;
	}
	else{
		c[0] = c[1] = c[2] = 0.5f; c[3] = 1.0f;
	}
	//選択時に点滅する
	if (mStart && mVariable1 == 0 && mVariable2 == 1){
		if (mStartWaitTime > 20){
			c[0] = c[1] = c[2] = 1.0f;
		}
		else if (mStartWaitTime % 8 < 4){
			c[0] = c[1] = c[2] = 0.5f;
		}
	}
	glColor4fv(c);
	CText::DrawString("COURCE-2", 330, 280, 12, 14);

	if (mVariable1 == 0 && mVariable2 == 2){
		c[0] = c[1] = c[2] = 1.0f; c[3] = 1.0f;
	}
	else{
		c[0] = c[1] = c[2] = 0.5f; c[3] = 1.0f;
	}
	//選択時に点滅する
	if (mStart && mVariable1 == 0 && mVariable2 == 2){
		if (mStartWaitTime > 20){
			c[0] = c[1] = c[2] = 1.0f;
		}
		else if (mStartWaitTime % 8 < 4){
			c[0] = c[1] = c[2] = 0.5f;
		}
	}
	glColor4fv(c);
	CText::DrawString("COURCE-3", 580, 280, 12, 14);

	//最後に値を1.0fに戻す
	c[0] = c[1] = c[2] = 1.0f; c[3] = 1.0f;
	glColor4fv(c);

	char mrecord[70];// :も含めた最大文字数の設定
	if (mMode == 1){
		sprintf(mrecord, "BEST:%02d:%02d:%02d", CSceneRace::mRecord_A / 10000 % 100, CSceneRace::mRecord_A / 100 % 100, CSceneRace::mRecord_A % 100);
		CText::DrawString(mrecord, 20, 580, 10, 12);
	}
	else if (mMode == 2){
		sprintf(mrecord, "BEST:%02d:%02d:%02d", CSceneRace::mRecord_B / 10000 % 100, CSceneRace::mRecord_B / 100 % 100, CSceneRace::mRecord_B % 100);
		CText::DrawString(mrecord, 20, 580, 10, 12);
	}
	else if (mMode == 3){
		sprintf(mrecord, "BEST:%02d:%02d:%02d", CSceneRace::mRecord_C / 10000 % 100, CSceneRace::mRecord_C / 100 % 100, CSceneRace::mRecord_C % 100);
		CText::DrawString(mrecord, 20, 580, 10, 12);
	}
	else if (mMode == 4){
		sprintf(mrecord, "BEST:%02d:%02d:%02d", CSceneRace::mRecord_D / 10000 % 100, CSceneRace::mRecord_D / 100 % 100, CSceneRace::mRecord_D % 100);
		CText::DrawString(mrecord, 20, 580, 10, 12);
	}
	else if (mMode == 5){
		sprintf(mrecord, "BEST:%02d:%02d:%02d", CSceneRace::mRecord_E / 10000 % 100, CSceneRace::mRecord_E / 100 % 100, CSceneRace::mRecord_E % 100);
		CText::DrawString(mrecord, 20, 580, 10, 12);
	}
	else if (mMode == 6){
		sprintf(mrecord, "BEST:%02d:%02d:%02d", CSceneRace::mRecord_F / 10000 % 100, CSceneRace::mRecord_F / 100 % 100, CSceneRace::mRecord_F % 100);
		CText::DrawString(mrecord, 20, 580, 10, 12);
	}
	else if (mMode == 127){
		sprintf(mrecord, "EDIT");
		CText::DrawString(mrecord, 20, 580, 10, 12);
	}


	c[0] = c[1] = c[2] = 0.5f;
	glColor4fv(c);
	//DrawBox(0, 0, 640, 480, White, TRUE);
	c[0] = c[1] = c[2] = 1.0f;
	/*c[0] = rand() % 11 * 0.1f;
	c[1] = rand() % 11 * 0.1f;
	c[2] = rand() % 11 * 0.1f;*/
	glColor4fv(c);	


	/*glBegin(GL_TRIANGLES);	
	glVertex2d(0 + 200, 0 + 200);
	glVertex2d(400 +200 , 300 + 200);
	glVertex2d(0 + 200, 300 + 200);
	glEnd();
	glBegin(GL_TRIANGLES);
	glVertex2d(0 + 200, 0 + 200);
	glVertex2d(400 + 200, 0 + 200);
	glVertex2d(400 + 200, 300 + 200);
	glEnd();*/


	
	/*int x_zahyo = 400, y_zahyo = 300;
	int width = 100, height = 100;
	glBegin(GL_TRIANGLES);	
	glVertex2d(x_zahyo - width, y_zahyo - height);
	glVertex2d(x_zahyo + width, y_zahyo + height);
	glVertex2d(x_zahyo - width, y_zahyo + height);
	glEnd();
	glBegin(GL_TRIANGLES);
	glVertex2d(x_zahyo - width, y_zahyo - height);
	glVertex2d(x_zahyo + width, y_zahyo - height);
	glVertex2d(x_zahyo + width, y_zahyo + height);
	glEnd();*/
	
	/*CRectangle::DrawRectangle(10, 10, 10, 10, 10, 10, 10, 10);
	CRectangle::Render();*/
	//RenderRect(400, 300, 100, 100);
	
	float colo[] = { 1.0f, 1.0f, 1.0f, 0.5f };
	colo[3] = 0.6f;
	glColor4fv(colo);

	if (mStartWaitTime >= WAITTIME_STARTFADEOUT){
		c[0] = c[1] = c[2] = 0.0f;
		c[3] = 0.025f * (mStartWaitTime - (WAITTIME_STARTFADEOUT));
		glColor4fv(c);
		CRectangle::Render(400, 300, 400, 300);
	}	
	c[0] = c[1] = c[2] = c[3] = 1.0f;
	glColor4fv(c);



	//シーンが移行する直前で表示
	if (mStartWaitTime > WAITTIME_NOWLOADING){
		CText::DrawString("Please Wait...", 555, 14, 9, 11);
	}
	//2D描画終了
	End2D();

	if (CKey::Once(VK_RETURN)){
		//開始フラグが建ったら連打しようが音は鳴らない
		if (mStart == false){
			SoundDecide.Play();
		}
		if (mSelectScene_Level < 2){
			//次に選ぶ項目へ
			mSelectScene_Level++;
		}
		else{
			//選び終えたらゲーム開始
			mStart = true;
		}
	}
	if (mStart){
		if (mStartWaitTime < WAITTIME_STARTLOAD){
			mStartWaitTime++;
		}
		else{
			//次のシーンはレース画面
			printf("選択したコース番号:No.%d  ", mMode);
			printf("選択したCPUのレベル:%d\n", mDifficulty);
			//選択したコースに対応するシーンへ移行			
			if (mMode == 1){
				//次のシーンはコース1
				mScene = ERACE1;
			}
			else if (mMode == 2){
				//次のシーンはコース2
				mScene = ERACE2;
			}
			else if (mMode == 3){
				//次のシーンはコース3
				mScene = ERACE3;
			}
			else if (mMode == 4){
				//次のシーンはコース3
				mScene = ERACE4;
			}
			else if (mMode == 5){
				//次のシーンはコース3
				mScene = ERACE5;
			}
			else if (mMode == 6){
				//次のシーンはコース3
				mScene = ERACE6;
			}
			else if (mMode == 127){
				//コースエディタに移行
				mScene = EEDIT;
			}
		}
	}

	//まだ選択してない時
	if (mStart == false){
		//矢印キーで選択
		//選択画面1:モードの選択
		if (mSelectScene_Level == 1){
			//if (CKey::Once(VK_UP)){
			//	//次のシーンはゲーム
			//	if (mVariable1 < 0){
			//		mVariable1 += 1;
			//	}
			//}
			//if (CKey::Once(VK_DOWN)){
			//	//次のシーンはゲーム
			//	if (mVariable1 > -1){
			//		mVariable1 -= 1;
			//	}
			//}
			if (CKey::Once(VK_LEFT)){
				//次のシーンはゲーム
				if (mVariable2 > 0){
					mVariable2 -= 1;
				}
			}
			if (CKey::Once(VK_RIGHT)){
				//次のシーンはゲーム
				if (mVariable2 < 2){
					mVariable2 += 1;
				}
			}
		}
		//選択画面2：敵AIの強さの設定
		else if (mSelectScene_Level == 2){
			if (CKey::Once(VK_LEFT)){
				if (mDifficulty > 1){
					mDifficulty--;
				}
				else{
					mDifficulty = 3;
				}
			}
			if (CKey::Once(VK_RIGHT)){
				if (mDifficulty < 3){
					mDifficulty++;
				}
				else{
					mDifficulty = 1;
				}
			}
			//Escキーか、BackSpaceキーで、前の選択画面に戻る
			if (CKey::Once(VK_BACK) || CKey::Once(VK_ESCAPE)){
				mSelectScene_Level--;
				SoundCancel.Play();
			}
		}
	}
	if (mVariable1 == 0 && mVariable2 == 0){
		mMode = 1;
	}
	else if (mVariable1 == 0 && mVariable2 == 1){
		mMode = 2;
	}
	else if (mVariable1 == 0 && mVariable2 == 2){
		mMode = 5;
	}
	else if (mVariable1 == -1 && mVariable2 == 0){
		mMode = 127;//EDITORのNo.
	}
	else if (mVariable1 == -1 && mVariable2 == 1){
		mMode = 3;
	}
	else if (mVariable1 == -1 && mVariable2 == 2){
		mMode = 6;
	}

	//カーソルの場所が1f前と変わった瞬間
	if (mPrevVariable1 != mVariable1 || mPrevVariable2 != mVariable2 || mPrevDifficulty != mDifficulty){
		SoundMoveCarsol.Play();
		mPrevVariable1 = mVariable1;
		mPrevVariable2 = mVariable2;
		mPrevDifficulty = mDifficulty;
	}

}

void CSceneTitle::Render(){

}

void CSceneTitle::RenderRect(int x, int y, int w, int h){
	glBegin(GL_TRIANGLES);
	glVertex2d(x - w, y - h);
	glVertex2d(x + w, y + h);
	glVertex2d(x - w, y + h);
	glEnd();
	glBegin(GL_TRIANGLES);
	glVertex2d(x - w, y - h);
	glVertex2d(x + w, y - h);
	glVertex2d(x + w, y + h);
	glEnd();
}